{% extends "base.html" %}

{% block title %}<title>Организационная структура</title>
{% load static %}
    <link href="{% static 'css/drevo.css' %}" rel="stylesheet" />{% endblock %}

{% block content %}
<div class="container">
        <canvas id="connections"></canvas>

        <!-- Уровень 1 -->
        <div class="block">
            <div class="card highlight" id="level1-1">
                <h3>Председатель банка</h3>
                <p>Ответственный за общее управление и стратегию банка.</p>
                <button onclick="openModal('level1-1')">Подробнее</button>
            </div>
        </div>

        <!-- Уровень 2 -->
        <div class="row">
            <div class="card" id="level2-1">
                <h3>Заместитель председателя банка</h3>
                <p>Розничный блок</p>
                <button onclick="openModal('level2-1')">Подробнее</button>
            </div>
            <div class="card" id="level2-2">
                <h3>Заместитель председателя банка</h3>
                <p>Корпоративный блок</p>
                <button onclick="openModal('level2-2')">Подробнее</button>
            </div>
        </div>

        <!-- Уровень 3 -->
        <div class="row">
            <div class="card" id="level3-1">
                <h3>Директор управления</h3>
                <p>Работа с филиалами</p>
                <button onclick="openModal('level3-1')">Подробнее</button>
            </div>
            <div class="card" id="level3-2">
                <h3>Владелец продукта</h3>
                <p>Онлайн-банкинг</p>
                <button onclick="openModal('level3-2')">Подробнее</button>
            </div>
            <div class="card" id="level3-3">
                <h3>Владелец продукта</h3>
                <p>Ипотека</p>
                <button onclick="openModal('level3-3')">Подробнее</button>
            </div>
            <div class="card" id="level3-4">
                <h3>Директор управления</h3>
                <p>Работа с филиалами</p>
                <button onclick="openModal('level3-4')">Подробнее</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title"></h2>
            <p id="modal-description"></p>
            <ul>
                <li><strong>ID:</strong> <span id="modal-id"></span></li>
                <li><strong>Имя:</strong> <span id="modal-name"></span></li>
                <li><strong>Фамилия:</strong> <span id="modal-surname"></span></li>
                <li><strong>Должность:</strong> <span id="modal-position"></span></li>
                <li><strong>Email:</strong> <span id="modal-email"></span></li>
            </ul>
        </div>
    </div>


    <script>


        // Функция для рисования линий
        function drawLines() {
            const canvas = document.getElementById('connections');
            const ctx = canvas.getContext('2d');

            // Устанавливаем размер canvas
            const container = document.querySelector('.container');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Получение координат центра блока
            function getCenter(element) {
                const rect = element.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                return {
                    x: rect.left + rect.width / 2 - containerRect.left,
                    y: rect.top + rect.height / 2 - containerRect.top,
                };
            }

            // Рисование линии
            function drawLine(start, end, color = 'black', width = 2) {
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.stroke();
            }

            // Связи прямые (чёрные) и функциональные (фиолетовые)
            const directConnections = [
                { from: 'level1-1', to: ['level2-1', 'level2-2'] },
                { from: 'level2-1', to: ['level3-1', 'level3-2', 'level3-3'] },
                { from: 'level2-2', to: ['level3-4'] },
            ];

            const functionalConnections = [
                { from: 'level3-1', to: ['level3-4'] },
                { from: 'level3-2', to: ['level3-3'] },
            ];

            // Рисуем прямые связи
            directConnections.forEach(conn => {
                const fromElement = document.getElementById(conn.from);
                const fromCenter = getCenter(fromElement);

                conn.to.forEach(toId => {
                    const toElement = document.getElementById(toId);
                    const toCenter = getCenter(toElement);

                    drawLine(fromCenter, toCenter, 'black', 2);
                });
            });

            // Рисуем функциональные связи
            functionalConnections.forEach(conn => {
                const fromElement = document.getElementById(conn.from);
                const fromCenter = getCenter(fromElement);

                conn.to.forEach(toId => {
                    const toElement = document.getElementById(toId);
                    const toCenter = getCenter(toElement);

                    drawLine(fromCenter, toCenter, 'purple', 1.5);
                });
            });
        }

        // Перерисовка линий при загрузке и изменении размера окна
        window.addEventListener('load', drawLines);
        window.addEventListener('resize', drawLines);

        // Открытие модального окна и отображение информации
        function openModal(levelId) {
            const employee = employees[levelId];

            document.getElementById('modal-title').textContent = employee.position;
            document.getElementById('modal-description').textContent = employee.description;
            document.getElementById('modal-id').textContent = employee.id;
            document.getElementById('modal-name').textContent = employee.name;
            document.getElementById('modal-surname').textContent = employee.surname;
            document.getElementById('modal-position').textContent = employee.position;
            document.getElementById('modal-email').textContent = employee.email;

            document.getElementById('modal').style.display = 'block';
        }

        // Закрытие модального окна
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
    </script>
{% endblock %}